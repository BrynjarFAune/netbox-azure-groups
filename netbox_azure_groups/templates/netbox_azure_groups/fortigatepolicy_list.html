{% extends 'generic/object_list.html' %}
{% load buttons %}
{% load helpers %}

{% block title %}FortiGate Policies{% endblock %}

{% block header %}
<div class="row">
    <div class="col-sm-8 col-md-9">
        <h1>{% block pretitle %}{% endblock %}FortiGate Policies</h1>
    </div>
    <div class="col-sm-4 col-md-3 text-end">
        {# Bookmark button removed due to compatibility issues #}
    </div>
</div>
{% endblock header %}

{% block content_title %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h3><i class="mdi mdi-firewall text-danger"></i> FortiGate Policy Browser</h3>
        <p class="text-muted">Browse and search through {{ object_count }} FortiGate firewall policies with AI-generated descriptions</p>
    </div>
    <div>
        <span class="badge bg-info">{{ filter.qs.count }} of {{ object_count }} policies</span>
    </div>
</div>
{% endblock content_title %}

{% block bulk_buttons %}
{# No bulk operations for read-only FortiGate policies #}
{% endblock bulk_buttons %}

{% block extra_controls %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="mdi mdi-magnify"></i> Quick Search & Filters</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="policy_id" class="form-label">Policy ID</label>
                        <input type="number" class="form-control" id="policy_id" name="policy_id" 
                               value="{{ request.GET.policy_id }}" placeholder="e.g. 42">
                    </div>
                    <div class="col-md-3">
                        <label for="name" class="form-label">Policy Name</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ request.GET.name }}" placeholder="Search names...">
                    </div>
                    <div class="col-md-6">
                        <label for="ai_description" class="form-label">Description Search</label>
                        <input type="text" class="form-control" id="ai_description" name="ai_description" 
                               value="{{ request.GET.ai_description }}" placeholder="Search AI descriptions...">
                    </div>
                    <div class="col-md-2">
                        <label for="action" class="form-label">Action</label>
                        <select class="form-select" id="action" name="action">
                            <option value="">All Actions</option>
                            <option value="accept" {% if request.GET.action == 'accept' %}selected{% endif %}>Accept</option>
                            <option value="deny" {% if request.GET.action == 'deny' %}selected{% endif %}>Deny</option>
                            <option value="ipsec" {% if request.GET.action == 'ipsec' %}selected{% endif %}>IPSec</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="enable" {% if request.GET.status == 'enable' %}selected{% endif %}>Enabled</option>
                            <option value="disable" {% if request.GET.status == 'disable' %}selected{% endif %}>Disabled</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="nat_enabled" class="form-label">NAT</label>
                        <select class="form-select" id="nat_enabled" name="nat_enabled">
                            <option value="">All Policies</option>
                            <option value="true" {% if request.GET.nat_enabled == 'true' %}selected{% endif %}>With NAT</option>
                            <option value="false" {% if request.GET.nat_enabled == 'false' %}selected{% endif %}>Without NAT</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fortigate_host" class="form-label">FortiGate Host</label>
                        <input type="text" class="form-control" id="fortigate_host" name="fortigate_host" 
                               value="{{ request.GET.fortigate_host }}" placeholder="e.g. fortigate.example.com">
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex gap-2 align-items-end h-100">
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-magnify"></i> Search
                            </button>
                            <a href="{% url 'plugins:netbox_azure_groups:fortigatepolicy_list' %}" class="btn btn-outline-secondary">
                                <i class="mdi mdi-refresh"></i> Reset
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Search Results Summary -->
{% if request.GET %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="mdi mdi-information"></i>
            <strong>Search Results:</strong> Found {{ filter.qs.count }} policies matching your criteria
            {% if request.GET.policy_id %} | Policy ID: <code>{{ request.GET.policy_id }}</code>{% endif %}
            {% if request.GET.name %} | Name: "{{ request.GET.name }}"{% endif %}
            {% if request.GET.ai_description %} | Description: "{{ request.GET.ai_description }}"{% endif %}
            {% if request.GET.action %} | Action: {{ request.GET.action }}{% endif %}
            {% if request.GET.nat_enabled %} | NAT: {{ request.GET.nat_enabled }}{% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock extra_controls %}

{% block table_controls %}
<!-- Policy Statistics -->
<div class="row mb-3">
    <div class="col-12">
        <div class="row text-center">
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1">Total Policies</h6>
                        <h4 class="text-primary mb-0">{{ object_count }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1">Active</h6>
                        <h4 class="text-success mb-0">{{ stats.enabled|default:0 }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1">With NAT</h6>
                        <h4 class="text-warning mb-0">{{ stats.nat_enabled|default:0 }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1">Allow Policies</h6>
                        <h4 class="text-success mb-0">{{ stats.accept|default:0 }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1">Block Policies</h6>
                        <h4 class="text-danger mb-0">{{ stats.deny|default:0 }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body py-2">
                        <h6 class="mb-1">In Use</h6>
                        <h4 class="text-info mb-0">{{ stats.linked|default:0 }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock table_controls %}